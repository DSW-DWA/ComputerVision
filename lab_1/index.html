<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>lab_1</title>
    <script src="https://docs.opencv.org/master/opencv.js" type="text/javascript"></script>
</head>
<style>
    #colorCanvasContainer {
        display: flex;
    }
</style>
<body>
    <h2>Original Image</h2>
    <canvas id="originalCanvas" width="512" height="512"></canvas>

    <h2>Grayscale Image</h2>
    <canvas id="grayCanvas" width="512" height="512"></canvas>

    <h2>Color Components</h2>
    <div id="colorCanvasContainer">
        <canvas id="redCanvas" width="512" height="512" alt="Red"></canvas>
        <canvas id="greenCanvas" width="512" height="512" alt="Green"></canvas>
        <canvas id="blueCanvas" width="512" height="512" alt="Blue"></canvas>
    </div>

    <h2>Histograms</h2>
    <canvas id="histCanvas" width="512" height="512"></canvas>
    <script>
        cv['onRuntimeInitialized']=()=>{
            let img = new Image();
            img.src = 'image.png';
            img.onload = function() {
                let originalCanvas = document.getElementById('originalCanvas');
                let ctxOriginal = originalCanvas.getContext('2d');

                ctxOriginal.drawImage(img, 0, 0);
                let src = cv.imread('originalCanvas');

                let dstGray = new cv.Mat();
                cv.cvtColor(src, dstGray, cv.COLOR_RGBA2GRAY, 0);

                cv.imshow('grayCanvas', dstGray);
                // src.delete(); dst.delete();
                
                let channels = [];
                for (let i = 0; i < src.channels(); i++) {
                    let channel = new cv.MatVector();
                    cv.split(src, channel);
                    channels.push(channel);
                }
                
                cv.imshow('redCanvas', channels[0].get(0));
                cv.imshow('greenCanvas', channels[1].get(0));
                cv.imshow('blueCanvas', channels[2].get(0));


                let dstSrc = new cv.Mat();
                cv.cvtColor(channels[0].get(0), dstSrc, cv.COLOR_RGBA2GRAY, 0);
                let srcVec = new cv.MatVector();
                srcVec.push_back(dstSrc);
                let accumulate = false;
                channels = [0];
                let histSize = [256];
                let ranges = [0, 255];
                let hist = new cv.Mat();
                let mask = new cv.Mat();
                let color = new cv.Scalar(255, 255, 255);
                let scale = 2;
                // You can try more different parameters
                cv.calcHist(srcVec, channels, mask, hist, histSize, ranges, accumulate);
                let result = cv.minMaxLoc(hist, mask);
                let max = result.maxVal;
                let dst = new cv.Mat.zeros(dstSrc.rows, histSize[0] * scale,
                                        cv.CV_8UC3);
                // draw histogram
                for (let i = 0; i < histSize[0]; i++) {
                    let binVal = hist.data32F[i] * dstSrc.rows / max;
                    let point1 = new cv.Point(i * scale, dstSrc.rows - 1);
                    let point2 = new cv.Point((i + 1) * scale - 1, dstSrc.rows - binVal);
                    cv.rectangle(dst, point1, point2, color, cv.FILLED);
                }

                cv.imshow('histCanvas', dst);
                // let grayCanvas = document.getElementById('grayCanvas');
                // let colorCanvas = document.getElementById('colorCanvas');
                // let histCanvas = document.getElementById('histCanvas');

                
                // let ctxGray = grayCanvas.getContext('2d');
                // let ctxColor = colorCanvas.getContext('2d');
                // let ctxHist = histCanvas.getContext('2d');


                // // Compute and display histograms
                // cv.imread(originalCanvas, function(mat) {
                //     let histSize = 256;
                //     let hist = new cv.Mat();
                //     let channels = [0];
                //     let mask = new cv.Mat();
                //     let histSizeArray = [histSize];
                //     let ranges = [0, 256];
                //     let accumulate = false;

                //     // Compute histogram for each channel
                //     for (let i = 0; i < mat.channels(); i++) {
                //         cv.calcHist([mat], channels, mask, hist, histSizeArray, ranges, accumulate);
                //         let histData = hist.data32F;

                //         // Draw histogram
                //         let bin_w = histCanvas.width / histSize;
                //         for (let j = 0; j < histSize; j++) {
                //             let bin_x = j * bin_w;
                //             let bin_y = histCanvas.height - Math.round(histData[j] * histCanvas.height / mat.rows);
                //             ctxHist.fillRect(bin_x, bin_y, bin_w, histCanvas.height - bin_y);
                //         }
                //     }

                //     hist.delete();
                //     mask.delete();
                // });
            };
        };

    </script>
</body>
</html>
